/** * VLM (Vortex Lattice Method) Visualization * Displays lattice grid, circulation distribution, and wake vortices */import React, { useState, useEffect, useRef } from 'react';import { Canvas, useFrame } from '@react-three/fiber';import { OrbitControls, Line, Text } from '@react-three/drei';import * as THREE from 'three';import axios from 'axios';import { Wind, Grid3x3, Activity } from 'lucide-react';// Horseshoe Vortex Componentconst HorseshoeVortex = ({ position, span, chord, circulation, color }) => {  const points = [    new THREE.Vector3(position[0] - span/2, position[1], position[2]),    new THREE.Vector3(position[0] - span/2, position[1], position[2] + chord),    new THREE.Vector3(position[0] + span/2, position[1], position[2] + chord),    new THREE.Vector3(position[0] + span/2, position[1], position[2])  ];  const lineWidth = Math.abs(circulation) * 2;  return (    <Line      points={points}      color={color}      lineWidth={lineWidth}      dashed={false}    />  );};// Lattice Grid Componentconst LatticeGrid = ({ panels, circulationData }) => {  const getCirculationColor = (circulation) => {    const normalized = (circulation + 1) / 2; // Normalize to 0-1    return new THREE.Color().setHSL(0.6 - normalized * 0.6, 1, 0.5);  };  return (    <group>      {panels.map((panel, idx) => (        <HorseshoeVortex          key={idx}          position={panel.position}          span={panel.span}          chord={panel.chord}          circulation={circulationData[idx] || 0}          color={getCirculationColor(circulationData[idx] || 0)}        />      ))}    </group>  );};// Wake Vortex Sheetconst WakeVortices = ({ wakeData }) => {  return (    <group>      {wakeData.map((wake, idx) => (        <Line          key={idx}          points={wake.points}          color="#ff6b6b"          lineWidth={1}          dashed={true}        />      ))}    </group>  );};// Velocity Vectorsconst VelocityVectors = ({ velocityField }) => {  return (    <group>      {velocityField.map((vec, idx) => {        const start = new THREE.Vector3(...vec.position);        const end = start.clone().add(new THREE.Vector3(...vec.velocity).multiplyScalar(0.1));                return (          <Line            key={idx}            points={[start, end]}            color="#4ecdc4"            lineWidth={1}          />        );      })}    </group>  );};const VLMVisualization = () => {  const [vlmData, setVlmData] = useState(null);  const [showWake, setShowWake] = useState(true);  const [showVelocity, setShowVelocity] = useState(false);  const [showCirculation, setShowCirculation] = useState(true);  const [parameters, setParameters] = useState({    velocity: 250,    alpha: 5.0,    yaw: 0.0  });  useEffect(() => {    loadVLMData();  }, [parameters]);  const loadVLMData = async () => {    try {      const response = await axios.post('http://localhost:8001/api/v1/vlm-solve', {        mesh_id: 'wing_v3.2',        velocity: parameters.velocity / 3.6, // Convert km/h to m/s        alpha: parameters.alpha,        yaw: parameters.yaw      });      setVlmData(response.data);    } catch (error) {      // Generate mock VLM data      setVlmData(generateMockVLMData());    }  };  const generateMockVLMData = () => {    const nSpan = 20;    const nChord = 10;    const panels = [];    const circulation = [];    const wake = [];    const velocityField = [];    // Generate lattice panels    for (let i = 0; i < nSpan; i++) {      for (let j = 0; j < nChord; j++) {        const y = (i - nSpan/2) * 0.1;        const x = j * 0.05;                panels.push({          position: [y, 0, x],          span: 0.1,          chord: 0.05        });        // Circulation distribution (elliptical)        const spanPos = (i - nSpan/2) / (nSpan/2);        const circ = Math.sqrt(1 - spanPos * spanPos) * 0.5;        circulation.push(circ);      }    }    // Generate wake vortices    for (let i = 0; i < nSpan; i++) {      const y = (i - nSpan/2) * 0.1;      wake.push({        points: [          new THREE.Vector3(y, 0, 0.5),          new THREE.Vector3(y, 0, 2.0)        ]      });    }    // Generate velocity field    for (let i = 0; i < 50; i++) {      velocityField.push({        position: [          (Math.random() - 0.5) * 2,          (Math.random() - 0.5) * 0.5,          Math.random() * 0.5        ],        velocity: [          0.1,          (Math.random() - 0.5) * 0.05,          (Math.random() - 0.5) * 0.05        ]      });    }    return {      panels,      circulation,      wake,      velocityField,      forces: {        lift: 2800,        drag: 420,        moment: 150      },      coefficients: {        Cl: 2.8,        Cd: 0.42,        L_D: 6.67      }    };  };  return (    <div className="p-6 bg-white rounded-lg shadow-lg">      <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">        <Grid3x3 className="w-6 h-6" />        VLM (Vortex Lattice Method) Visualization      </h2>      {/* Controls */}      <div className="mb-4 grid grid-cols-3 gap-4">        <div>          <label className="block text-sm font-medium mb-1">Velocity (km/h)</label>          <input            type="number"            value={parameters.velocity}            onChange={(e) => setParameters({...parameters, velocity: parseFloat(e.target.value)})}            className="w-full px-3 py-2 border rounded"          />        </div>        <div>          <label className="block text-sm font-medium mb-1">Angle of Attack (┬░)</label>          <input            type="number"            step="0.5"            value={parameters.alpha}            onChange={(e) => setParameters({...parameters, alpha: parseFloat(e.target.value)})}            className="w-full px-3 py-2 border rounded"          />        </div>        <div>          <label className="block text-sm font-medium mb-1">Yaw Angle (┬░)</label>          <input            type="number"            step="0.5"            value={parameters.yaw}            onChange={(e) => setParameters({...parameters, yaw: parseFloat(e.target.value)})}            className="w-full px-3 py-2 border rounded"          />        </div>      </div>      {/* Display Options */}      <div className="mb-4 flex gap-4">        <label className="flex items-center gap-2">          <input            type="checkbox"            checked={showCirculation}            onChange={(e) => setShowCirculation(e.target.checked)}          />          <span className="text-sm">Circulation Distribution</span>        </label>        <label className="flex items-center gap-2">          <input            type="checkbox"            checked={showWake}            onChange={(e) => setShowWake(e.target.checked)}          />          <span className="text-sm">Wake Vortices</span>        </label>        <label className="flex items-center gap-2">          <input            type="checkbox"            checked={showVelocity}            onChange={(e) => setShowVelocity(e.target.checked)}          />          <span className="text-sm">Velocity Vectors</span>        </label>      </div>      {/* 3D Visualization */}      <div className="mb-4 bg-gray-900 rounded-lg" style={{ height: '500px' }}>        <Canvas camera={{ position: [3, 2, 3], fov: 50 }}>          <ambientLight intensity={0.5} />          <pointLight position={[10, 10, 10]} />          <pointLight position={[-10, -10, -10]} intensity={0.3} />          {vlmData && (            <>              {showCirculation && (                <LatticeGrid                  panels={vlmData.panels}                  circulationData={vlmData.circulation}                />              )}                            {showWake && (                <WakeVortices wakeData={vlmData.wake} />              )}                            {showVelocity && (                <VelocityVectors velocityField={vlmData.velocityField} />              )}            </>          )}          <gridHelper args={[5, 20]} />          <axesHelper args={[2]} />          <OrbitControls />        </Canvas>      </div>      {/* Results */}      {vlmData && (        <div className="grid grid-cols-3 gap-4">          <div className="p-4 bg-blue-50 border border-blue-200 rounded">            <div className="text-sm text-blue-700">Lift Coefficient</div>            <div className="text-3xl font-bold text-blue-900">{vlmData.coefficients.Cl.toFixed(3)}</div>          </div>          <div className="p-4 bg-green-50 border border-green-200 rounded">            <div className="text-sm text-green-700">Drag Coefficient</div>            <div className="text-3xl font-bold text-green-900">{vlmData.coefficients.Cd.toFixed(3)}</div>          </div>          <div className="p-4 bg-purple-50 border border-purple-200 rounded">            <div className="text-sm text-purple-700">L/D Ratio</div>            <div className="text-3xl font-bold text-purple-900">{vlmData.coefficients.L_D.toFixed(2)}</div>          </div>        </div>      )}      {/* Legend */}      <div className="mt-4 p-3 bg-gray-50 rounded text-sm">        <strong>Legend:</strong>        <div className="grid grid-cols-3 gap-2 mt-2">          <div className="flex items-center gap-2">            <div className="w-4 h-4 bg-blue-500 rounded"></div>            <span>High Circulation</span>          </div>          <div className="flex items-center gap-2">            <div className="w-4 h-4 bg-red-500 rounded"></div>            <span>Wake Vortices</span>          </div>          <div className="flex items-center gap-2">            <div className="w-4 h-4 bg-cyan-500 rounded"></div>            <span>Velocity Vectors</span>          </div>        </div>      </div>    </div>  );};export default VLMVisualization;