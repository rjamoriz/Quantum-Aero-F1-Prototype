# Quantum-Aero F1 Prototype - Docker Compose Configuration
# Orchestrates all microservices for the platform

version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================
  
  mongodb:
    image: mongo:7
    container_name: qaero-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: qaero
    networks:
      - qaero-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/qaero --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: qaero-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - qaero-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Microservices
  # ============================================================================

  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    container_name: qaero-backend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - MONGODB_URI=mongodb://mongodb:27017/qaero
      - REDIS_URL=redis://redis:6379
      - PHYSICS_SERVICE_URL=http://physics-engine:8001
      - ML_SERVICE_URL=http://ml-surrogate:8000
      - QUANTUM_SERVICE_URL=http://quantum-optimizer:8002
      - NATS_URL=nats://nats:4222
      - LOG_LEVEL=info
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - qaero-network
    volumes:
      - ./services/backend/logs:/app/logs

  physics-engine:
    build:
      context: ./services/physics-engine
      dockerfile: Dockerfile
    container_name: qaero-physics-engine
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    networks:
      - qaero-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ML Surrogate Service (to be implemented)
  # ml-surrogate:
  #   build:
  #     context: ./services/ml-surrogate
  #     dockerfile: Dockerfile
  #   container_name: qaero-ml-surrogate
  #   restart: unless-stopped
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - PYTHONUNBUFFERED=1
  #     - CUDA_VISIBLE_DEVICES=0
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 1
  #             capabilities: [gpu]
  #   networks:
  #     - qaero-network

  # Quantum Optimizer Service (to be implemented)
  # quantum-optimizer:
  #   build:
  #     context: ./services/quantum-optimizer
  #     dockerfile: Dockerfile
  #   container_name: qaero-quantum-optimizer
  #   restart: unless-stopped
  #   ports:
  #     - "8002:8002"
  #   environment:
  #     - PYTHONUNBUFFERED=1
  #   networks:
  #     - qaero-network

  # ============================================================================
  # GenAI Agents (Already deployed - from docker-compose.agents.yml)
  # ============================================================================
  
  nats:
    image: nats:2.11.8-alpine
    container_name: qaero-nats
    restart: unless-stopped
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # HTTP monitoring
    command: ["-js", "-m", "8222"]
    networks:
      - qaero-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

# ============================================================================
# Networks
# ============================================================================

networks:
  qaero-network:
    driver: bridge
    name: qaero-network

# ============================================================================
# Volumes
# ============================================================================

volumes:
  mongodb_data:
    name: qaero-mongodb-data
  redis_data:
    name: qaero-redis-data
